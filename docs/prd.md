## 1. 产品概述
### 1.1 产品定义
ThinkingMap 是一款交互式AI问题解决可视化助手，将AI的思考和问题解决过程转化为可视化的图结构，允许用户在过程中随时干预、提问。

### 1.2 产品愿景
使AI辅助问题解决过程变得透明、可控且结构化，让用户真正参与到思考过程中，而不仅仅是得到最终答案。

### 1.3 目标用户
+ 研究人员和学者
+ 学生和教育工作者
+ 内容创作者和写作者
+ 分析师和决策者
+ 产品和项目管理人员

### 1.4 用户痛点
+ 现有AI助手给出答案的过程不透明，用户难以理解和信任
+ 复杂问题需要多步骤思考，但传统AI交互难以清晰展示思路演进
+ 用户想要在思考过程中提供输入和调整方向，而不只是在开始和结束时
+ 现有解决方案缺乏结构化的问题分解和可视化

### 1.5 产品核心价值
+ **透明化思考**: 可视化AI的问题解决步骤和逻辑
+ **用户控制**: 在任何阶段干预和引导思考方向
+ **结构化思维**: 将复杂问题分解为可管理的步骤
+ **探索性思考**: 支持多种可能的解决路径和分支

## 2. 用户场景
### 场景一：研究问题分析
用户输入一个研究问题，系统将问题拆解为文献回顾、研究方法确定、数据收集方案等步骤。用户可以在每个步骤执行后深入特定方向，或添加自己的见解和约束条件。

### 场景二：创意构思
用户需要为一个产品生成创意概念，系统帮助分解为目标用户分析、现有产品评估、创新点发散、概念整合等步骤。用户可以在创意生成阶段追加关键词或调整方向。

### 场景三：决策规划
用户面临复杂决策，系统帮助拆解为选项列举、评估标准确定、利弊分析、风险评估等步骤。用户可以在分析过程中提供额外信息或调整权重。

### 场景四：学习辅助
学生使用系统理解复杂概念，系统将概念分解为基础知识回顾、核心原理解释、应用场景分析、例题解析等步骤。学生可以在不理解的地方提问，系统会创建解释分支。

## 3. 功能需求
### 3.1 问题输入与初步分析
#### 3.1.1 问题输入界面
+ 提供明确的文本输入区域，支持多行输入
+ 字数提示和建议（最佳问题字数范围：50-200字）
+ 问题类型选择（研究型、创意型、分析型、规划型）
+ "历史问题"快速访问下拉菜单

#### 3.1.2 问题理解确认
+ 系统自动提取并显示问题的核心要点
+ 显示系统对问题的初步理解，包括目标和约束条件
+ 用户可确认或修正系统的理解
+ 提供"开始分析"按钮进入下一阶段

### 3.2 可视化工作区
#### 3.2.1 可视化思考图展示
**基础架构**

+ 基于 ReactFlow 实现的可视化工作区，占用界面左侧 65% 宽度（默认）
+ 支持节点拖拽、缩放、平移等基础交互操作
+ 自动布局算法，确保节点层次清晰、连接线美观

**节点设计**

+ 初始状态：工作区仅展示一个根节点
+ 节点信息展示：
    - 节点类型标识（图标+文字）
    - 问题概述（限制40字符，超出显示省略号）
    - 目标概述（限制30字符，超出显示省略号）
    - 结论概述（仅在已完成状态显示，限制50字符）
+ 节点状态标识：
    - 待执行（灰色边框）
    - 执行中（蓝色边框+动画效果）
    - 已完成（绿色边框+完成图标）
    - 错误状态（红色边框+警告图标）

#### 3.2.2 节点交互功能
**单击交互**

+ 单击节点后，在节点上方弹出功能按钮组
+ 按钮组包含：
    - 修改节点（编辑图标）
    - 删除节点（删除图标，需二次确认）
    - 新增子节点（加号图标）
+ 按钮组自动定位，避免超出可视区域
+ 点击其他区域时按钮组自动隐藏

**双击交互**

+ 双击节点触发右侧操作面板展开
+ 操作面板展示当前节点的详细信息和操作界面
+ 同时高亮显示当前选中节点

#### 3.2.3 实时更新机制
+ 通过 SSE 接收后端节点变更事件
+ 支持的事件类型：
    - 创建节点事件
    - 更新节点事件
    - 删除节点事件
    - 节点状态变更事件
+ 节点变更时提供平滑的动画过渡效果

### 3.3 操作面板系统
#### 3.3.1 面板基础功能
**布局设计**

+ 默认占用界面右侧 35% 宽度
+ 支持拖拽调节宽度（最小 25%，最大 50%）
+ 可折叠/展开，折叠时仅显示窄边栏
+ Tab 标题垂直排列在面板左侧

**Tab 导航**

+ Tab 标题采用垂直布局，位于面板左侧
+ 当前激活 Tab 高亮显示
+ 根据节点状态动态显示可用 Tab

#### 3.3.2 节点信息 Tab
**信息展示区域**

+ 当前问题：多行文本展示，支持编辑
+ 目标描述：多行文本展示，支持编辑
+ 上下文背景：富文本编辑器，支持格式化
+ 结论内容：仅在已完成状态显示，只读模式

**执行控制**

+ 前置依赖检查：
    - 检查所有父节点是否已完成
    - 显示依赖状态列表
    - 未满足依赖时禁用执行按钮
+ 执行按钮：
    - 满足依赖条件时显示"开始执行"按钮
    - 点击后请求后端判断是否需要拆解
    - 根据后端响应决定跳转到拆解Tab或结论Tab

**操作按钮**

+ 保存修改：保存当前节点信息修改
+ 重置：恢复到上次保存状态
+ 删除节点：删除当前节点（需确认）

#### 3.3.3 问题拆解 Tab
**显示条件**

+ 仅当后端判断当前节点需要拆解时显示
+ 从信息Tab点击"开始执行"后自动跳转到此Tab

**对话界面**

+ 聊天式交互界面，支持多轮对话
+ 消息类型：
    - 系统消息：拆解进度、节点创建通知等
    - AI消息：拆解分析、子问题建议等
    - 用户消息：引导调整、确认修改等

**拆解流程**

1. 自动开始：Tab激活后自动开始拆解流程
2. RAG查询：后端进行相关信息检索
3. 拆解分析：AI分析并提出子问题建议
4. 节点创建：确认后创建子节点（同步更新可视化区域）
5. 用户调整：用户可通过对话调整拆解结果

**实时同步**

+ 通过SSE接收节点创建/更新事件
+ 实时更新可视化区域的节点显示
+ 在对话中同步显示节点变更通知

#### 3.3.4 结论生成 Tab
**显示条件**

+ 当节点无需拆解时，从信息Tab直接跳转
+ 当拆解完成后，可切换到此Tab

**对话界面**

+ 类似拆解Tab的聊天式界面
+ 专注于基于已知信息生成结论

**结论生成流程**

1. 信息汇总：展示当前节点的所有相关信息
2. 结论生成：AI基于信息生成初步结论
3. 用户交互：用户可提问、要求调整或补充
4. 结论确认：用户确认最终结论
5. 节点完成：标记节点为已完成状态

### 3.4 后端交互机制
#### 3.4.1 SSE 通信协议
**连接管理**

+ 建立持久化SSE连接
+ 支持连接断开重连机制
+ 连接状态指示器

**事件类型定义**

```json
{
  "type": "node_created",
  "data": {
    "nodeID": "string",
    "parentID": "string",
    "nodeType": "string",
    "question": "string",
    "target": "string",
    "position": {"x": number, "y": number}
  }
}

{
  "type": "node_updated",
  "data": {
    "nodeID": "string",
    "updates": {
      "question": "string",
      "target": "string",
      "conclusion": "string",
      "status": "string"
    }
  }
}

{
  "type": "node_deleted",
  "data": {
    "nodeID": "string"
  }
}

{
  "type": "thinking_progress",
  "data": {
    "nodeID": "string",
    "stage": "string",
    "message": "string"
  }
}
```

#### 3.4.2 API 接口设计
**节点操作接口**

+ `POST /api/nodes` - 创建节点
+ `PUT /api/nodes/{nodeID}` - 更新节点
+ `DELETE /api/nodes/{nodeID}` - 删除节点
+ `GET /api/nodes/{nodeID}/dependencies` - 检查节点依赖

**思考流程接口**

+ `POST /api/thinking/analyze` - 开始问题分析
+ `POST /api/thinking/decompose` - 开始问题拆解
+ `POST /api/thinking/conclude` - 开始结论生成
+ `POST /api/thinking/conversation` - 对话交互

### 3.5 用户体验设计
#### 3.5.1 响应式设计
+ 支持最小宽度 1200px 的桌面端显示
+ 面板宽度自适应调节
+ 节点大小根据内容自适应

#### 3.5.2 加载状态管理
+ 节点执行时显示加载动画
+ SSE连接状态指示
+ 操作按钮的禁用/启用状态管理

#### 3.5.3 错误处理
+ 网络错误提示和重试机制
+ 节点执行失败的错误显示
+ 数据保存失败的提示和恢复

#### 3.5.4 快捷操作
+ 键盘快捷键支持（Ctrl+S保存，Delete删除等）
+ 右键菜单快速操作
+ 拖拽创建节点连接

## 4. 验收标准
#### 4.1 功能验收
- [ ] 可视化工作区正常显示和交互
- [ ] 节点的创建、修改、删除功能正常
- [ ] 操作面板三个Tab正常切换和显示
- [ ] SSE通信稳定，节点变更实时同步
- [ ] 依赖检查和执行控制正确工作

#### 4.2 性能验收
- [ ] 支持100个节点的流畅操作
- [ ] 页面加载时间小于3秒
- [ ] 节点操作响应时间小于500ms
- [ ] SSE连接稳定性99%以上

#### 4.3 用户体验验收
- [ ] 界面布局合理，操作直观
- [ ] 错误提示清晰，引导明确
- [ ] 加载状态反馈及时
- [ ] 支持常用快捷键操作

